<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Stats</title>
</head>
<body>
    <h1>Player Stats Query</h1>
    <p>Enter a User ID to display their stats:</p>
    <input type="text" id="userIdInput" placeholder="User ID">
    <button onclick="loadData()">Get Stats</button>
    <button onclick="downloadCSV()">CSV</button>
    <table id="resultsTable" border="1">
        <!-- The table will be populated here -->
    </table>

    <script>
        let userRows = []; // Store filtered data for both display and CSV download

        // Fetch and display data for the user
        async function loadData() {
            const userId = document.getElementById('userIdInput').value;
            
            // Fetch the CSV file from the correct path
            const response = await fetch('../../data/wbuserdata.csv');
            const data = await response.text();

            // Parse the CSV data
            const rows = data.split('\n').map(row => row.split(','));

            // Extract the headers
            const headers = rows[0];

            // Filter rows based on User ID
            userRows = rows.filter(row => row[headers.indexOf('UserID')] === userId);

            // Populate the table with the results
            const resultsTable = document.getElementById('resultsTable');
            resultsTable.innerHTML = ''; // Clear previous results

            // Add table header
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.innerText = header;
                headerRow.appendChild(th);
            });
            resultsTable.appendChild(headerRow);

            // Add user data rows
            userRows.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.innerText = cell;
                    tr.appendChild(td);
                });
                resultsTable.appendChild(tr);
            });
        }

        // Download the filtered user data as a CSV file
        function downloadCSV() {
            if (userRows.length === 0) {
                alert('No data available to download.');
                return;
            }

            const csvHeaders = 'Date,Squad,Name,UserID,Level,XP,JoinTime,PingTime,Banned,Coins,KillsELO,GamesELO,Number_of_Jumps,Zombie_Deaths,Zombie_Kills,Zombie_Wins,Time,Time_Alive_Count,Time_Alive_Longest,Time_Alive,Zombie_Time_Alive_Count,Zombie_Time_Alive,BGM,DamageDealt_p52,DamageDealt_p53,DamageDealt_p54,DamageDealt_p55,DamageDealt_p56,DamageDealt_p57,DamageDealt_p58,DamageDealt_p59,DamageDealt_p60,AR,AK,Pistol,HR,RPG,Shotgun,SR,SMG,Homing,Grenade,HeliMinigun,TankMinigun,Knife,Revolver,Minigun,GL,DamageDealt_p82,DamageDealt_p83,DamageDealt_p84,DamageDealt_p85,DamageDealt_p86,DamageDealt_p87,Fists,VSS,Fifty,MGTurret,XBow,SCAR,TacShotty,VEK,DamageDealt_p96,DamageDealt_p97,LMG,DamageDealt_p101,DamageDealt_p104,DamageDealt_p105,DamageDealt_p110,LaserMine,DamageDealt_p112,Losses_m00,Losses_m10,Losses_m09,Losses_m08,Losses_m07\n';

            let csvContent = csvHeaders + userRows.map(e => e.join(",")).join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");

            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `user_${document.getElementById('userIdInput').value}_stats.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
